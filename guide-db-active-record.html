<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="language" content="en" />
        <link href="./assets/b2f98e95/css/bootstrap.css" rel="stylesheet">
<link href="./assets/d607947b/style.css" rel="stylesheet">
<script src="./assets/ff75f2d2/jquery.js"></script>
<script src="./assets/b2f98e95/js/bootstrap.js"></script>
<script src="./assets/ee9fb928/jssearch.js"></script>    <title>Yii Framework 2.0 API Documentation</title>
</head>
<body>

<div class="wrap">
    <nav id="w311" class="navbar-inverse navbar-fixed-top navbar" role="navigation"><div class="navbar-header"><button class="navbar-toggle" data-toggle="collapse" data-target="#w311-collapse"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span></button><a class="navbar-brand" href="./index.html">Yii 2.0 API 文档</a></div><div id="w311-collapse" class="collapse navbar-collapse"><ul id="w312" class="navbar-nav nav"><li><a href="./index.html">类参考</a></li>
<li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown">扩展 <b class="caret"></b></a><ul id="w313" class="dropdown-menu"><li><a href="./ext-apidoc-index.html" tabindex="-1">apidoc</a></li>
<li><a href="./ext-authclient-index.html" tabindex="-1">authclient</a></li>
<li><a href="./ext-bootstrap-index.html" tabindex="-1">bootstrap</a></li>
<li><a href="./ext-codeception-index.html" tabindex="-1">codeception</a></li>
<li><a href="./ext-composer-index.html" tabindex="-1">composer</a></li>
<li><a href="./ext-debug-index.html" tabindex="-1">debug</a></li>
<li><a href="./ext-elasticsearch-index.html" tabindex="-1">elasticsearch</a></li>
<li><a href="./ext-faker-index.html" tabindex="-1">faker</a></li>
<li><a href="./ext-gii-index.html" tabindex="-1">gii</a></li>
<li><a href="./ext-imagine-index.html" tabindex="-1">imagine</a></li>
<li><a href="./ext-jui-index.html" tabindex="-1">jui</a></li>
<li><a href="./ext-mongodb-index.html" tabindex="-1">mongodb</a></li>
<li><a href="./ext-redis-index.html" tabindex="-1">redis</a></li>
<li><a href="./ext-smarty-index.html" tabindex="-1">smarty</a></li>
<li><a href="./ext-sphinx-index.html" tabindex="-1">sphinx</a></li>
<li><a href="./ext-swiftmailer-index.html" tabindex="-1">swiftmailer</a></li>
<li><a href="./ext-twig-index.html" tabindex="-1">twig</a></li></ul></li>
<li><a href="./guide-README.html">权威指南</a></li>
<li class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown">Github <b class="caret"></b></a><ul id="w314" class="dropdown-menu"><li><a href="https://github.com/yiisoft/yii2" tabindex="-1">Yii 2.0</a></li>
<li><a href="https://github.com/yii2-chinesization/yii2-zh-cn" tabindex="-1">Yii 2.0 中文化项目</a></li>
<li><a href="https://github.com/AbrahamGreyson/abrahamgreyson.github.io" tabindex="-1">docwithcn.com</a></li></ul></li></ul><div class="navbar-form navbar-left" role="search">
  <div class="form-group">
    <input id="searchbox" type="text" class="form-control" placeholder="Search">
  </div>
</div>
</div></nav>
    <div id="search-resultbox" style="display: none;" class="modal-content">
        <ul id="search-results">
        </ul>
    </div>

    
<div class="row">
    <div class="col-md-2">
                <div id="navigation" class="list-group"><a class="list-group-item" href="#navigation-294" data-toggle="collapse" data-parent="#navigation">介绍 <b class="caret"></b></a><div id="navigation-294" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-intro-yii.html">关于 Yii</a>
<a class="list-group-item" href="./guide-intro-upgrade-from-v1.html">从 Yii 1.1 升级</a></div>
<a class="list-group-item" href="#navigation-295" data-toggle="collapse" data-parent="#navigation">入门 <b class="caret"></b></a><div id="navigation-295" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-start-installation.html">安装 Yii</a>
<a class="list-group-item" href="./guide-start-workflow.html">运行应用</a>
<a class="list-group-item" href="./guide-start-hello.html">第一次问候</a>
<a class="list-group-item" href="./guide-start-forms.html">使用 Forms</a>
<a class="list-group-item" href="./guide-start-databases.html">玩转 Databases</a>
<a class="list-group-item" href="./guide-start-gii.html">用 Gii 生成代码</a>
<a class="list-group-item" href="./guide-start-looking-ahead.html">更上一层楼</a></div>
<a class="list-group-item" href="#navigation-296" data-toggle="collapse" data-parent="#navigation">应用结构 <b class="caret"></b></a><div id="navigation-296" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-structure-overview.html">结构总览</a>
<a class="list-group-item" href="./guide-structure-entry-scripts.html">入口脚本</a>
<a class="list-group-item" href="./guide-structure-applications.html">应用</a>
<a class="list-group-item" href="./guide-structure-application-components.html">应用组件</a>
<a class="list-group-item" href="./guide-structure-controllers.html">控制器（Controller）</a>
<a class="list-group-item" href="./guide-structure-views.html">视图（View）</a>
<a class="list-group-item" href="./guide-structure-models.html">模型（Model）</a>
<a class="list-group-item" href="./guide-structure-filters.html">过滤器</a>
<a class="list-group-item" href="./guide-structure-widgets.html">小部件（Widget）</a>
<a class="list-group-item" href="./guide-structure-modules.html">模块（Module）</a>
<a class="list-group-item" href="./guide-structure-assets.html">前端资源（Asset）</a>
<a class="list-group-item" href="./guide-structure-extensions.html">扩展（extensions）</a></div>
<a class="list-group-item" href="#navigation-297" data-toggle="collapse" data-parent="#navigation">请求处理 <b class="caret"></b></a><div id="navigation-297" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-runtime-bootstrapping.html">引导（Bootstrapping）</a>
<a class="list-group-item" href="./guide-runtime-routing.html">路由（Routing）</a>
<a class="list-group-item" href="./guide-runtime-requests.html">请求（Request）</a>
<a class="list-group-item" href="./guide-runtime-responses.html">响应（Response）</a>
<a class="list-group-item" href="./guide-runtime-sessions-cookies.html">Sessions（会话）和 Cookies</a>
<a class="list-group-item" href="./guide-runtime-url-handling.html">URL 解析和生成</a>
<a class="list-group-item" href="./guide-runtime-handling-errors.html">错误处理</a>
<a class="list-group-item" href="./guide-runtime-logging.html">日志</a></div>
<a class="list-group-item" href="#navigation-298" data-toggle="collapse" data-parent="#navigation">关键概念 <b class="caret"></b></a><div id="navigation-298" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-concept-components.html">组件（Component）</a>
<a class="list-group-item" href="./guide-concept-properties.html">属性（Property）</a>
<a class="list-group-item" href="./guide-concept-events.html">事件（Event）</a>
<a class="list-group-item" href="./guide-concept-behaviors.html">行为（Behavior）</a>
<a class="list-group-item" href="./guide-concept-configurations.html">配置（Configurations）</a>
<a class="list-group-item" href="./guide-concept-autoloading.html">类自动加载（Autoloading）</a>
<a class="list-group-item" href="./guide-concept-alias.html">别名（Alias）</a>
<a class="list-group-item" href="./guide-concept-service-locator.html">服务定位器（Service Locator）</a>
<a class="list-group-item" href="./guide-concept-di-container.html">依赖注入容器（DI Container）</a></div>
<a class="list-group-item active" href="#navigation-299" data-toggle="collapse" data-parent="#navigation">配合数据库工作 <b class="caret"></b></a><div id="navigation-299" class="submenu panel-collapse collapse in"><a class="list-group-item" href="./guide-db-dao.html">数据访问对象（DAO）</a>
<a class="list-group-item" href="./guide-db-query-builder.html">查询生成器（Query Builder）</a>
<a class="list-group-item active" href="./guide-db-active-record.html">活动记录（Active Record）</a>
<a class="list-group-item" href="./guide-db-migrations.html">数据库迁移（Migration）</a>
<a class="list-group-item" href="./guide-db-sphinx.html">Sphinx</a>
<a class="list-group-item" href="./guide-db-redis.html">Redis</a>
<a class="list-group-item" href="./guide-db-mongodb.html">MongoDB</a>
<a class="list-group-item" href="./guide-db-elastic-search.html">ElasticSearch</a></div>
<a class="list-group-item" href="#navigation-300" data-toggle="collapse" data-parent="#navigation">接收用户数据 <b class="caret"></b></a><div id="navigation-300" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-input-forms.html">创建表单</a>
<a class="list-group-item" href="./guide-input-validation.html">输入验证</a>
<a class="list-group-item" href="./guide-input-file-uploading.html">文件上传</a>
<a class="list-group-item" href="./guide-input-multiple-models.html">多模型同时输入</a></div>
<a class="list-group-item" href="#navigation-301" data-toggle="collapse" data-parent="#navigation">显示数据 <b class="caret"></b></a><div id="navigation-301" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-output-formatting.html">格式化输出数据</a>
<a class="list-group-item" href="./guide-output-pagination.html">分页（Pagination）</a>
<a class="list-group-item" href="./guide-output-sorting.html">排序（Sorting）</a>
<a class="list-group-item" href="./guide-output-data-providers.html">数据提供器</a>
<a class="list-group-item" href="./guide-output-data-widgets.html">数据小部件</a>
<a class="list-group-item" href="./guide-output-theming.html">主题</a></div>
<a class="list-group-item" href="#navigation-302" data-toggle="collapse" data-parent="#navigation">安全 <b class="caret"></b></a><div id="navigation-302" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-security-authentication.html">认证（Authentication）</a>
<a class="list-group-item" href="./guide-security-authorization.html">授权（Authorization）</a>
<a class="list-group-item" href="./guide-security-passwords.html">处理密码</a>
<a class="list-group-item" href="./guide-security-auth-clients.html">客户端认证</a>
<a class="list-group-item" href="./guide-security-best-practices.html">安全领域的最佳实践</a></div>
<a class="list-group-item" href="#navigation-303" data-toggle="collapse" data-parent="#navigation">缓存 <b class="caret"></b></a><div id="navigation-303" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-caching-overview.html">概述</a>
<a class="list-group-item" href="./guide-caching-data.html">数据缓存</a>
<a class="list-group-item" href="./guide-caching-fragment.html">片段缓存</a>
<a class="list-group-item" href="./guide-caching-page.html">分页缓存</a>
<a class="list-group-item" href="./guide-caching-http.html">HTTP 缓存</a></div>
<a class="list-group-item" href="#navigation-304" data-toggle="collapse" data-parent="#navigation">RESTful Web 服务 <b class="caret"></b></a><div id="navigation-304" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-rest-quick-start.html">快速入门</a>
<a class="list-group-item" href="./guide-rest-resources.html">资源</a>
<a class="list-group-item" href="./guide-rest-routing.html">路由</a>
<a class="list-group-item" href="./guide-rest-response-formatting.html">格式化响应</a>
<a class="list-group-item" href="./guide-rest-authentication.html">授权验证</a>
<a class="list-group-item" href="./guide-rest-rate-limiting.html">速率限制</a>
<a class="list-group-item" href="./guide-rest-versioning.html">版本化</a>
<a class="list-group-item" href="./guide-rest-error-handling.html">错误处理</a>
<a class="list-group-item" href="./guide-rest-testing.html">测试</a></div>
<a class="list-group-item" href="#navigation-305" data-toggle="collapse" data-parent="#navigation">开发工具 <b class="caret"></b></a><div id="navigation-305" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tool-debugger.html">调试工具栏和调试器</a>
<a class="list-group-item" href="./guide-tool-gii.html">使用 Gii 生成代码</a>
<a class="list-group-item" href="./guide-tool-api-doc.html">生成 API 文档</a></div>
<a class="list-group-item" href="#navigation-306" data-toggle="collapse" data-parent="#navigation">测试 <b class="caret"></b></a><div id="navigation-306" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-test-overview.html">概述</a>
<a class="list-group-item" href="./guide-test-unit.html">单元测试</a>
<a class="list-group-item" href="./guide-test-functional.html">功能测试</a>
<a class="list-group-item" href="./guide-test-acceptance.html">验收测试</a>
<a class="list-group-item" href="./guide-test-fixtures.html">测试夹具</a></div>
<a class="list-group-item" href="#navigation-307" data-toggle="collapse" data-parent="#navigation">高级专题 <b class="caret"></b></a><div id="navigation-307" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tutorial-advanced-app.html">高级应用模版</a>
<a class="list-group-item" href="./guide-tutorial-start-from-scratch.html">从头构建自定义模版</a>
<a class="list-group-item" href="./guide-tutorial-console.html">控制台命令</a>
<a class="list-group-item" href="./guide-tutorial-core-validators.html">核心验证器</a>
<a class="list-group-item" href="./guide-tutorial-i18n.html">国际化</a>
<a class="list-group-item" href="./guide-tutorial-mailing.html">收发邮件</a>
<a class="list-group-item" href="./guide-tutorial-performance-tuning.html">性能优化</a>
<a class="list-group-item" href="./guide-tutorial-shared-hosting.html">共享主机环境</a>
<a class="list-group-item" href="./guide-tutorial-template-engines.html">模板引擎</a>
<a class="list-group-item" href="./guide-tutorial-yii-integration.html">集成第三方代码</a></div>
<a class="list-group-item" href="#navigation-308" data-toggle="collapse" data-parent="#navigation">小部件 <b class="caret"></b></a><div id="navigation-308" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-widget-bootstrap.html">Bootstrap 小部件</a>
<a class="list-group-item" href="./guide-widget-jui.html">Jquery UI 小部件</a></div>
<a class="list-group-item" href="#navigation-309" data-toggle="collapse" data-parent="#navigation">助手类 <b class="caret"></b></a><div id="navigation-309" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-helper-overview.html">助手一览</a>
<a class="list-group-item" href="./guide-helper-array.html">ArrayHelper</a>
<a class="list-group-item" href="./guide-helper-html.html">Html</a>
<a class="list-group-item" href="./guide-helper-url.html">Url</a>
<a class="list-group-item" href="./guide-helper-security.html">security</a></div>
<a class="list-group-item" href="#navigation-310" data-toggle="collapse" data-parent="#navigation">不在目录内的文件 <b class="caret"></b></a><div id="navigation-310" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-glossary.html">glossary</a></div></div>    </div>
    <div class="col-md-9 guide-content" role="main">
        <h1>Active Record（活动记录） <a href="#active-record-huo-dong-ji-lu" name="active-record-huo-dong-ji-lu" class="hashlink">&para;</a></h1>
<p><a href="http://zh.wikipedia.org/wiki/Active_Record">Active Record</a> （活动记录，以下简称AR）提供了一个面向对象的接口，
用以访问数据库中的数据。一个 AR 类关联一张数据表，
每个 AR 对象对应表中的一行，对象的属性（即 AR 的特性Attribute）映射到数据行的对应列。
一条活动记录（AR对象）对应数据表的一行，AR对象的属性则映射该行的相应列。
您可以直接以面向对象的方式来操纵数据表中的数据，妈妈再不用担心我需要写原生 SQL 语句啦。</p>
<p>例如，假定 <code>Customer</code> AR 类关联着 <code>customer</code> 表，且该类的 <code>name</code> 属性代表 <code>customer</code> 表的 <code>name</code> 列。
你可以写以下代码来哉 <code>customer</code> 表里插入一行新的记录:</p>
<p>用 AR 而不是原生的 SQL 语句去执行数据库查询，可以调用直观方法来实现相同目标。如，调用 <a href="./yii-db-baseactiverecord.html#save()-detail">save()</a> 方法将执行插入或更新轮询，将在该 AR 类关联的数据表新建或更新一行数据：</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">name&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'李狗蛋'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;一行新数据插入&nbsp;customer&nbsp;表</span></code></pre>
<p>上面的代码和使用下面的原生 SQL 语句是等效的，但显然前者更直观，
更不易出错，并且面对不同的数据库系统（DBMS, Database Management System）时更不容易产生兼容性问题。</p>
<pre><code class="language-php"><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">createCommand</span><span style="color: #007700">(</span><span style="color: #DD0000">'INSERT&nbsp;INTO&nbsp;customer&nbsp;(name)&nbsp;VALUES&nbsp;(:name)'</span><span style="color: #007700">,&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">':name'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'李狗蛋'</span><span style="color: #007700">,<br />])-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">();</span></code></pre>
<p>下面是所有目前被 Yii 的 AR 功能所支持的数据库列表：</p>
<ul>
<li>MySQL 4.1 及以上：通过 <a href="./yii-db-activerecord.html">yii\db\ActiveRecord</a></li>
<li>PostgreSQL 7.3 及以上：通过 <a href="./yii-db-activerecord.html">yii\db\ActiveRecord</a></li>
<li>SQLite 2 和 3：通过 <a href="./yii-db-activerecord.html">yii\db\ActiveRecord</a></li>
<li>Microsoft SQL Server 2010 及以上：通过 <a href="./yii-db-activerecord.html">yii\db\ActiveRecord</a></li>
<li>Oracle: 通过 <a href="./yii-db-activerecord.html">yii\db\ActiveRecord</a></li>
<li>CUBRID 9.1 及以上：通过 <a href="./yii-db-activerecord.html">yii\db\ActiveRecord</a></li>
<li>Sphnix：通过 <a href="./yii-sphinx-activerecord.html">yii\sphinx\ActiveRecord</a>，需求 <code>yii2-sphinx</code> 扩展</li>
<li>ElasticSearch：通过 <a href="./yii-elasticsearch-activerecord.html">yii\elasticsearch\ActiveRecord</a>，需求 <code>yii2-elasticsearch</code> 扩展</li>
<li>Redis 2.6.12 及以上：通过 <a href="./yii-redis-activerecord.html">yii\redis\ActiveRecord</a>，需求 <code>yii2-redis</code> 扩展</li>
<li>MongoDB 1.3.0 及以上：通过 <a href="./yii-mongodb-activerecord.html">yii\mongodb\ActiveRecord</a>，需求 <code>yii2-mongodb</code> 扩展</li>
</ul>
<p>如你所见，Yii 不仅提供了对关系型数据库的 AR 支持，还提供了 NoSQL 数据库的支持。
在这个教程中，我们会主要描述对关系型数据库的 AR 用法。
然而，绝大多数的内容在 NoSQL 的 AR 里同样适用。</p>
<h2>声明 AR 类 <a href="#sheng-ming-ar-lei" name="sheng-ming-ar-lei" class="hashlink">&para;</a></h2>
<p>要想声明一个 AR 类，你需要扩展 <a href="./yii-db-activerecord.html">yii\db\ActiveRecord</a> 基类，
并实现 <code>tableName</code> 方法，返回与之相关联的的数据表的名称：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">app</span><span style="color: #007700">\</span><span style="color: #0000BB">models</span><span style="color: #007700">;<br /><br />use&nbsp;</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string&nbsp;返回该AR类关联的数据表名<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;static&nbsp;function&nbsp;</span><span style="color: #0000BB">tableName</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #DD0000">'customer'</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<h2>访问列数据 <a href="#fang-wen-lie-shu-ju" name="fang-wen-lie-shu-ju" class="hashlink">&para;</a></h2>
<p>AR 把相应数据行的每一个字段映射为 AR 对象的一个个特性变量（Attribute）
一个特性就好像一个普通对象的公共属性一样（public property）。
特性变量的名称和对应字段的名称是一样的，且大小姓名。</p>
<p>使用以下语法读取列的值：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;"id"&nbsp;和&nbsp;"mail"&nbsp;是&nbsp;$customer&nbsp;对象所关联的数据表的对应字段名<br /></span><span style="color: #0000BB">$id&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">id</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$email&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">email</span><span style="color: #007700">;</span></code></pre>
<p>要改变列值，只要给关联属性赋新值并保存对象即可：</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">email&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'哪吒@example.com'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();</span></code></pre>
<h2>建立数据库连接 <a href="#jian-li-shu-ju-ku-lian-jie" name="jian-li-shu-ju-ku-lian-jie" class="hashlink">&para;</a></h2>
<p>AR 用一个 <a href="./yii-db-connection.html">DB connection</a> 对象与数据库交换数据。
它使用 <code>db</code> 组件作为其连接对象。详见<a href="guide-database-basics.html">数据库基础</a>章节，
你可以在应用程序配置文件中设置下 <code>db</code> 组件，就像这样，</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">return&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'components'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'db'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'class'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'yii\db\Connection'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'dsn'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'mysql:host=localhost;dbname=testdb'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'username'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'demo'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'password'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'demo'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;],<br />];</span></code></pre>
<p>如果在你的应用中应用了不止一个数据库，且你需要给你的 AR 类使用不同的数据库链接（DB connection）
，你可以覆盖掉 <a href="./yii-db-activerecord.html#getDb()-detail">getDb()</a> 方法：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;static&nbsp;function&nbsp;</span><span style="color: #0000BB">getDb</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;\</span><span style="color: #0000BB">Yii</span><span style="color: #007700">::</span><span style="color: #0000BB">$app</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">db2</span><span style="color: #007700">;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;使用名为&nbsp;"db2"&nbsp;的应用组件<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br />}</span></code></pre>
<h2>查询数据 <a href="#cha-xun-shu-ju" name="cha-xun-shu-ju" class="hashlink">&para;</a></h2>
<p>AR 提供了两种方法来构建 DB 查询并向 AR 实例里填充数据：</p>
<ul>
<li><a href="./yii-db-activerecord.html#find()-detail">yii\db\ActiveRecord::find()</a></li>
<li><a href="./yii-db-activerecord.html#findBySql()-detail">yii\db\ActiveRecord::findBySql()</a></li>
</ul>
<p>以上两个方法都会返回 <a href="./yii-db-activequery.html">yii\db\ActiveQuery</a> 实例，该类继承自<a href="./yii-db-query.html">yii\db\Query</a>，
因此，他们都支持同一套灵活且强大的 DB 查询方法，如 <code>where()</code>，<code>join()</code>，<code>orderBy()</code>，等等。 
下面的这些案例展示了一些可能的玩法：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;取回所有活跃客户(状态为&nbsp;*active*&nbsp;的客户）并以他们的&nbsp;ID&nbsp;排序：<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">([</span><span style="color: #DD0000">'status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_ACTIVE</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">orderBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'id'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;返回ID为1的客户：<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">([</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">one</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;取回活跃客户的数量：<br /></span><span style="color: #0000BB">$count&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">([</span><span style="color: #DD0000">'status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_ACTIVE</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">count</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;以客户ID索引结果集：<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">indexBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'id'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;$customers&nbsp;数组以&nbsp;ID&nbsp;为索引<br /><br />//&nbsp;用原生&nbsp;SQL&nbsp;语句检索客户：<br /></span><span style="color: #0000BB">$sql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'SELECT&nbsp;*&nbsp;FROM&nbsp;customer'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findBySql</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span></code></pre>
<blockquote><p>小贴士：在上面的代码中，<code>Customer::STATUS_ACTIVE</code> 是一个在 <code>Customer</code> 类里定义的常量。（译者注：这种常量的值一般都是tinyint）相较于直接在代码中写死字符串或数字，使用一个更有意义的常量名称是一种更好的编程习惯。</p>
</blockquote>
<p><code>find()</code> 方法也支持用一种简化的用法，让你直接通过主键的值或者一系列其他字段值的数组来获取 AR 对象。
主要的不同点在于，
它并不返回 <a href="./yii-db-activequery.html">yii\db\ActiveQuery</a> 对象，而是基于输入的字段值，直接返回一个 AR 对象
而无需调用 <code>one()</code> 方法。</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;返回ID为1的客户：<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;返回ID为1的活跃客户：<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_ACTIVE</span><span style="color: #007700">,<br />]);</span></code></pre>
<h3>以数组形式获取数据 <a href="#yi-shu-zu-xing-shi-huo-qu-shu-ju" name="yi-shu-zu-xing-shi-huo-qu-shu-ju" class="hashlink">&para;</a></h3>
<p>有时候，我们需要处理很大量的数据，这时可能需要用一个数组来存储取到的数据，
从而节省内存。你可以用 <code>asArray()</code> 函数做到这一点：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;以数组而不是对象形式取回客户信息：<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">asArray</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;$customers&nbsp;的每个元素都是键值对数组</span></code></pre>
<h3>批量获取数据 <a href="#pi-liang-huo-qu-shu-ju" name="pi-liang-huo-qu-shu-ju" class="hashlink">&para;</a></h3>
<p>在 <a href="guide-query-builder.html">Query Builder（查询构造器）</a> 里，我们已经解释了当需要从数据库中查询大量数据时，你可以用 <em>batch query（批量查询）</em>来限制内存的占用。
你可能也想在 AR 里使用相同的技巧，比如这样……</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;一次提取&nbsp;10&nbsp;个客户信息<br /></span><span style="color: #007700">foreach&nbsp;(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">batch</span><span style="color: #007700">(</span><span style="color: #0000BB">10</span><span style="color: #007700">)&nbsp;as&nbsp;</span><span style="color: #0000BB">$customers</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;$customers&nbsp;是&nbsp;10&nbsp;个或更少的客户对象的数组<br /></span><span style="color: #007700">}<br /></span><span style="color: #FF8000">//&nbsp;一次提取&nbsp;10&nbsp;个客户并一个一个地遍历处理<br /></span><span style="color: #007700">foreach&nbsp;(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">each</span><span style="color: #007700">(</span><span style="color: #0000BB">10</span><span style="color: #007700">)&nbsp;as&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;$customer&nbsp;是一个&nbsp;”Customer“&nbsp;对象<br /></span><span style="color: #007700">}<br /></span><span style="color: #FF8000">//&nbsp;贪婪加载模式的批处理查询<br /></span><span style="color: #007700">foreach&nbsp;(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">each</span><span style="color: #007700">()&nbsp;as&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />}</span></code></pre>
<h2>操作数据 <a href="#cao-zuo-shu-ju" name="cao-zuo-shu-ju" class="hashlink">&para;</a></h2>
<p>AR 提供以下方法插入、更新和删除与 AR 对象关联的那张表中的某一行：</p>
<ul>
<li><a href="./yii-db-baseactiverecord.html#save()-detail">save()</a></li>
<li><a href="./yii-db-activerecord.html#insert()-detail">insert()</a></li>
<li><a href="./yii-db-activerecord.html#update()-detail">update()</a></li>
<li><a href="./yii-db-activerecord.html#delete()-detail">delete()</a></li>
</ul>
<p>AR 同时提供了一下静态方法，可以应用在与某 AR 类所关联的整张表上。
用这些方法的时候千万要小心，因为他们作用于整张表！
比如，<code>deleteAll()</code>  会删除掉表里<strong>所有</strong>的记录。</p>
<ul>
<li><a href="./yii-db-baseactiverecord.html#updateCounters()-detail">updateCounters()</a></li>
<li><a href="./yii-db-activerecord.html#updateAll()-detail">updateAll()</a></li>
<li><a href="./yii-db-activerecord.html#updateAllCounters()-detail">updateAllCounters()</a></li>
<li><a href="./yii-db-activerecord.html#deleteAll()-detail">deleteAll()</a></li>
</ul>
<p>下面的这些例子里，详细展现了如何使用这些方法：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;插入新客户的记录<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">name&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'詹姆斯'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">email&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'007@example.com'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;等同于&nbsp;$customer-&gt;insert();<br /><br />//&nbsp;更新现有客户记录<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">email&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'邦德@demo.com'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;等同于&nbsp;$customer-&gt;update();<br /><br />//&nbsp;删除已有客户记录<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">delete</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;所有客户的age（年龄）字段加1：<br /></span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">updateAllCounters</span><span style="color: #007700">([</span><span style="color: #DD0000">'age'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">]);</span></code></pre>
<blockquote><p>须知：<code>save()</code> 方法会调用 <code>insert()</code> 和 <code>update()</code> 中的一个，
用哪个取决于当前 AR 对象是不是新对象（在函数内部，他会检查 <a href="./yii-db-activerecord.html#$isNewRecord-detail">yii\db\ActiveRecord::$isNewRecord</a> 的值）。
若 AR 对象是由 <code>new</code> 操作符 初始化出来的，<code>save()</code> 方法会在表里<em>插入</em>一条数据；
如果一个 AR 是由 <code>find()</code> 方法获取来的，
则 <code>save()</code> 会<em>更新</em>表里的对应行记录。</p>
</blockquote>
<h3>数据输入与有效性验证 <a href="#shu-ju-shu-ru-yu-you-xiao-xing-yan-zheng" name="shu-ju-shu-ru-yu-you-xiao-xing-yan-zheng" class="hashlink">&para;</a></h3>
<p>Because Active Record extends from <a href="./yii-base-model.html">yii\base\Model</a>, it supports the same data input and validation features
as described in <a href="guide-model.html">Model</a>. For example, you may declare validation rules by overwriting the
<a href="./yii-base-model.html#rules()-detail">rules()</a> method; you may massively assign user input data to an Active Record instance;
and you may call <a href="./yii-base-model.html#validate()-detail">validate()</a> to trigger data validation.</p>
<p>When you call <code>save()</code>, <code>insert()</code> or <code>update()</code>, these methods will automatically call <a href="./yii-base-model.html#validate()-detail">validate()</a>.
If the validation fails, the corresponding data saving operation will be cancelled.</p>
<p>The following example shows how to use an Active Record to collect/validate user input and save them into database:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;record<br /></span><span style="color: #0000BB">$model&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">;<br />if&nbsp;(</span><span style="color: #0000BB">$model</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">load</span><span style="color: #007700">(</span><span style="color: #0000BB">Yii</span><span style="color: #007700">::</span><span style="color: #0000BB">$app</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">request</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">post</span><span style="color: #007700">())&nbsp;&amp;&amp;&nbsp;</span><span style="color: #0000BB">$model</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;the&nbsp;user&nbsp;input&nbsp;has&nbsp;been&nbsp;collected,&nbsp;validated&nbsp;and&nbsp;saved<br /></span><span style="color: #007700">}<br /><br /></span><span style="color: #FF8000">//&nbsp;updating&nbsp;a&nbsp;record&nbsp;whose&nbsp;primary&nbsp;key&nbsp;is&nbsp;$id<br /></span><span style="color: #0000BB">$model&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">);<br />if&nbsp;(</span><span style="color: #0000BB">$model&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">NotFoundHttpException</span><span style="color: #007700">;<br />}<br />if&nbsp;(</span><span style="color: #0000BB">$model</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">load</span><span style="color: #007700">(</span><span style="color: #0000BB">Yii</span><span style="color: #007700">::</span><span style="color: #0000BB">$app</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">request</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">post</span><span style="color: #007700">())&nbsp;&amp;&amp;&nbsp;</span><span style="color: #0000BB">$model</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;the&nbsp;user&nbsp;input&nbsp;has&nbsp;been&nbsp;collected,&nbsp;validated&nbsp;and&nbsp;saved<br /></span><span style="color: #007700">}</span></code></pre>
<h3>读取默认值 <a href="#du-qu-mo-ren-zhi" name="du-qu-mo-ren-zhi" class="hashlink">&para;</a></h3>
<p>Your table columns may be defined with default values. Sometimes, you may want to pre-populate your
Web form for an Active Record with these values. To do so, call the <code>loadDefaultValues()</code> method before
rendering the form:</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">loadDefaultValues</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;...&nbsp;渲染&nbsp;$customer&nbsp;的&nbsp;HTML&nbsp;表单&nbsp;...</span></code></pre>
<p>《《《待整理暂停线，下面的是以前翻译的，跟强哥前两天更新的不一样，还没有完全整理。</p>
<h2>数据输入和有效性验证 <a href="#shu-ju-shu-ru-he-you-xiao-xing-yan-zheng" name="shu-ju-shu-ru-he-you-xiao-xing-yan-zheng" class="hashlink">&para;</a></h2>
<p>AR 继承了 <a href="./yii-base-model.html">yii\base\Model</a> 的数据有效性验证和数据输入能力。有效性验证的方法会在数据保存时被调用。
数据的有效性验证会在 <code>save()</code> 方法执行时自动完成，如果验证失败，数据保存操作将取消。</p>
<p>更多细节请参看本指南的 <a href="guide-model.html">Model</a> 部分。</p>
<h2>查询关联的数据 <a href="#cha-xun-guan-lian-de-shu-ju" name="cha-xun-guan-lian-de-shu-ju" class="hashlink">&para;</a></h2>
<p>使用 AR 方法也可以查询数据表的关联数据（如，选出表A的数据可以拉出表B的关联数据）。
有了 AR，
返回的关联数据连接就像连接关联主表的 AR 对象的属性一样。</p>
<p>建立关联关系后，通过 <code>$customer-&gt;orders</code> 可以获取
一个 <code>Order</code> 对象的数组，该数组代表当前客户对象的订单集。</p>
<p>定义关联关系使用一个可以返回 <a href="./yii-db-activequery.html">yii\db\ActiveQuery</a> 对象的 getter 方法，
<a href="./yii-db-activequery.html">yii\db\ActiveQuery</a>对象有关联上下文的相关信息，因此可以只查询关联数据。</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;客户和订单通过&nbsp;Order.customer_id&nbsp;-&gt;&nbsp;id&nbsp;关联的一对多关系<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br />class&nbsp;</span><span style="color: #0000BB">Order&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;订单和客户通过&nbsp;Customer.id&nbsp;-&gt;&nbsp;customer_id&nbsp;关联的一对一关系<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">getCustomer</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasOne</span><span style="color: #007700">(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'customer_id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>以上使用了 <a href="./yii-db-baseactiverecord.html#hasMany()-detail">yii\db\ActiveRecord::hasMany()</a> 和 <a href="./yii-db-baseactiverecord.html#hasOne()-detail">yii\db\ActiveRecord::hasOne()</a> 方法。
以上两例分别是关联数据多对一关系和一对一关系的建模范例。
如，一个客户有很多订单，一个订单只归属一个客户。
两个方法都有两个参数并返回 <a href="./yii-db-activequery.html">yii\db\ActiveQuery</a> 对象。</p>
<ul>
<li><code>$class</code>：关联模型类名，它必须是一个完全合格的类名。</li>
<li><code>$link</code>: 两个表的关联列，应为键值对数组的形式。
数组的键是 <code>$class</code> 关联表的列名，
而数组值是关联类 $class 的列名。
基于表外键定义关联关系是最佳方法。</li>
</ul>
<p>建立关联关系后，获取关联数据和获取组件属性一样简单，
执行以下相应getter方法即可：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;取得客户的订单<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;$orders&nbsp;是&nbsp;Order&nbsp;对象数组</span></code></pre>
<p>以上代码实际执行了以下两条 SQL 语句：</p>
<pre><code class="language-sql">SELECT * FROM customer WHERE id=1;
SELECT * FROM order WHERE customer_id=1;
</code></pre>
<blockquote><p>提示:再次用表达式 <code>$customer-&gt;orders</code>将不会执行第二次 SQL 查询，
SQL 查询只在该表达式第一次使用时执行。
数据库访问只返回缓存在内部前一次取回的结果集，如果你想查询新的
关联数据，先要注销现有结果集：<code>unset($customer-&gt;orders);</code>。</p>
</blockquote>
<p>有时候需要在关联查询中传递参数，如不需要返回客户全部订单，
只需要返回购买金额超过设定值的大订单，
通过以下getter方法声明一个关联数据 <code>bigOrders</code> ：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getBigOrders</span><span style="color: #007700">(</span><span style="color: #0000BB">$threshold&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">100</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">(</span><span style="color: #DD0000">'subtotal&nbsp;&gt;&nbsp;:threshold'</span><span style="color: #007700">,&nbsp;[</span><span style="color: #DD0000">':threshold'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$threshold</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">orderBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'id'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p><code>hasMany()</code> 返回 <a href="./yii-db-activequery.html">yii\db\ActiveQuery</a> 对象，该对象允许你通过
<a href="./yii-db-activequery.html">yii\db\ActiveQuery</a> 方法定制查询。</p>
<p>如上声明后，执行<code>$customer-&gt;bigOrders</code> 就返回
总额大于100的订单。使用以下代码更改设定值：</p>
<pre><code class="language-php"><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getBigOrders</span><span style="color: #007700">(</span><span style="color: #0000BB">200</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span></code></pre>
<p>&gt;注意：关联查询返回的是 <a href="./yii-db-activequery.html">yii\db\ActiveQuery</a> 的实例，如果像特性（如类属性）那样连接关联数据，
返回的结果是关联查询的结果，即 <a href="./yii-db-activerecord.html">yii\db\ActiveRecord</a> 的实例，
或者是数组，或者是 null ，取决于关联关系的多样性。如，<code>$customer-&gt;getOrders()</code> 返回
<code>ActiveQuery</code> 实例，而 <code>$customer-&gt;orders</code> 返回<code>Order</code> 对象数组
（如果查询结果为空则返回空数组）。</p>
<h2>中间表关联 <a href="#zhong-jian-biao-guan-lian" name="zhong-jian-biao-guan-lian" class="hashlink">&para;</a></h2>
<p>有时，两个表通过中间表关联，定义这样的关联关系，
可以通过调用 <a href="./yii-db-activerelationtrait.html#via()-detail">via()</a> 方法或 <a href="./yii-db-activequery.html#viaTable()-detail">viaTable()</a> 方法来定制 <a href="./yii-db-activequery.html">yii\db\ActiveQuery</a> 对象
。</p>
<p>举例而言，如果 <code>order</code> 表和 <code>item</code>  表通过中间表 <code>order_item</code>关联起来，
可以在 <code>Order</code> 类声明 <code>items</code> 关联关系取代中间表：</p>
<p>《《《待处理标识符：上面两句狗屁不通的话需要参照原文修订下。</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Order&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getItems</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Item</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'item_id'</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">viaTable</span><span style="color: #007700">(</span><span style="color: #DD0000">'order_item'</span><span style="color: #007700">,&nbsp;[</span><span style="color: #DD0000">'order_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>两个方法是相似的，除了
<a href="./yii-db-activerelationtrait.html#via()-detail">via()</a> 方法的第一个参数是使用 AR 类中定义的关联名。
以上方法取代了中间表，等价于：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Order&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrderItems</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">OrderItem</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'order_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getItems</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Item</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'item_id'</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">via</span><span style="color: #007700">(</span><span style="color: #DD0000">'orderItems'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<h2>延迟加载和即时加载（又称惰性加载与贪婪加载） <a href="#yan-chi-jia-zai-he-ji-shi-jia-zai-you-cheng-duo-xing-jia-zai-yu-tan-lan-jia-zai" name="yan-chi-jia-zai-he-ji-shi-jia-zai-you-cheng-duo-xing-jia-zai-yu-tan-lan-jia-zai" class="hashlink">&para;</a></h2>
<p>如前所述，当你第一次连接关联对象时， AR 将执行一个数据库查询
来检索请求数据并填充到关联对象的相应属性。
如果再次连接相同的关联对象，不再执行任何查询语句，这种数据库查询的执行方法称为“延迟加载”。如：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SQL&nbsp;executed:&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;customer&nbsp;WHERE&nbsp;id=1<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//&nbsp;SQL&nbsp;executed:&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;order&nbsp;WHERE&nbsp;customer_id=1<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">;<br /></span><span style="color: #FF8000">//&nbsp;没有&nbsp;SQL&nbsp;语句被执行<br /></span><span style="color: #0000BB">$orders2&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//取回上次查询的缓存数据</span></code></pre>
<p>延迟加载非常实用，但是，在以下场景中使用延迟加载会遭遇性能问题：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SQL&nbsp;executed:&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;customer&nbsp;LIMIT&nbsp;100<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">limit</span><span style="color: #007700">(</span><span style="color: #0000BB">100</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /><br />foreach&nbsp;(</span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;SQL&nbsp;executed:&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;order&nbsp;WHERE&nbsp;customer_id=...<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...处理&nbsp;$orders...<br /></span><span style="color: #007700">}</span></code></pre>
<p>假设数据库查出的客户超过100个，以上代码将执行多少条 SQL 语句？
101 条！第一条 SQL 查询语句取回100个客户，然后，
每个客户要执行一条 SQL 查询语句以取回该客户的所有订单。</p>
<p>为解决以上性能问题，可以通过调用 <a href="./yii-db-activequerytrait.html#with()-detail">yii\db\ActiveQuery::with()</a> 方法使用<em>即时加载</em>解决。</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SQL&nbsp;executed:&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;customer&nbsp;LIMIT&nbsp;100;<br />//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;orders&nbsp;WHERE&nbsp;customer_id&nbsp;IN&nbsp;(1,2,...)<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">limit</span><span style="color: #007700">(</span><span style="color: #0000BB">100</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /><br />foreach&nbsp;(</span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;没有&nbsp;SQL&nbsp;语句被执行<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...处理&nbsp;$orders...<br /></span><span style="color: #007700">}</span></code></pre>
<p>如你所见，同样的任务只需要两个 SQL 语句。</p>
<blockquote><p>须知：通常，即时加载 N 个关联关系而通过 <code>via()</code> 或者 <code>viaTable()</code> 定义了 M 个关联关系，
将有 1+M+N 条 SQL 查询语句被执行：一个查询取回主表行数，
一个查询给每一个 (M) 中间表，一个查询给每个 (N) 关联表。</p>
</blockquote>
<blockquote><p>注意:当用即时加载定制 <code>select()</code> 时，确保连接
到关联模型的列都被包括了，否则，关联模型不会载入。如：</p>
</blockquote>
<pre><code class="language-php"><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">([</span><span style="color: #DD0000">'id'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'amount'</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;$orders[0]-&gt;customer&nbsp;总是空的，使用以下代码解决这个问题：<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">([</span><span style="color: #DD0000">'id'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'amount'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'customer_id'</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span></code></pre>
<p>有时候，你想自由的自定义关联查询，
延迟加载和即时加载都可以实现，如：</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//&nbsp;lazy&nbsp;loading:&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;order&nbsp;WHERE&nbsp;customer_id=1&nbsp;AND&nbsp;subtotal&gt;100<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">(</span><span style="color: #DD0000">'subtotal&gt;100'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;eager&nbsp;loading:&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;customer&nbsp;LIMIT&nbsp;100<br />//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;order&nbsp;WHERE&nbsp;customer_id&nbsp;IN&nbsp;(1,2,...)&nbsp;AND&nbsp;subtotal&gt;100<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">limit</span><span style="color: #007700">(</span><span style="color: #0000BB">100</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'orders'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;function(</span><span style="color: #0000BB">$query</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">andWhere</span><span style="color: #007700">(</span><span style="color: #DD0000">'subtotal&gt;100'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;},<br />])-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span></code></pre>
<h2>逆关系 <a href="#ni-guan-xi" name="ni-guan-xi" class="hashlink">&para;</a></h2>
<p>关联关系通常成对定义，如， <code>Customer</code> 可以有个名为 <code>orders</code> 关联项，
而 <code>Order</code> 也有个名为<code>customer</code> 的关联项：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;....<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br />class&nbsp;</span><span style="color: #0000BB">Order&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;....<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getCustomer</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasOne</span><span style="color: #007700">(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'customer_id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>如果我们执行以下查询，可以发现订单的 <code>customer</code> 和 
找到这些订单的客户对象并不是同一个。连接 <code>customer-&gt;orders</code> 将触发一条 SQL 语句
而连接一个订单的 <code>customer</code> 将触发另一条 SQL 语句。</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;customer&nbsp;WHERE&nbsp;id=1<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//&nbsp;echoes&nbsp;"not&nbsp;equal"<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;order&nbsp;WHERE&nbsp;customer_id=1<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;customer&nbsp;WHERE&nbsp;id=1<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">customer&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'equal'</span><span style="color: #007700">;<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'not&nbsp;equal'</span><span style="color: #007700">;<br />}</span></code></pre>
<p>为避免多余执行的后一条语句，我们可以为 <code>customer</code>或 <code>orders</code> 关联关系定义相反的关联关系，
通过调用 <a href="./yii-db-activerelationtrait.html#inverseOf()-detail">inverseOf()</a> 方法可以实现。</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;....<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">inverseOf</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>现在我们同样执行上面的查询，我们将得到：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;customer&nbsp;WHERE&nbsp;id=1<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//&nbsp;输出相同<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;order&nbsp;WHERE&nbsp;customer_id=1<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">customer&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'equal'</span><span style="color: #007700">;<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'not&nbsp;equal'</span><span style="color: #007700">;<br />}</span></code></pre>
<p>以上我们展示了如何在延迟加载中使用相对关联关系，
相对关系也可以用在即时加载中：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;customer<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;order&nbsp;WHERE&nbsp;customer_id&nbsp;IN&nbsp;(1,&nbsp;2,&nbsp;...)<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;输出相同<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$customers</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">customer&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">$customers</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">])&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'equal'</span><span style="color: #007700">;<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'not&nbsp;equal'</span><span style="color: #007700">;<br />}</span></code></pre>
<blockquote><p>注意:相对关系不能在包含中间表的关联关系中定义。
即是，如果你的关系是通过<a href="./yii-db-activerelationtrait.html#via()-detail">via()</a> 或 <a href="./yii-db-activequery.html#viaTable()-detail">viaTable()</a>方法定义的，
就不能调用<a href="./yii-db-activerelationtrait.html#inverseOf()-detail">yii\db\ActiveQuery::inverseOf()</a>方法了。</p>
</blockquote>
<h2> JOIN 类型关联查询 <a href="#join-lei-xing-guan-lian-cha-xun" name="join-lei-xing-guan-lian-cha-xun" class="hashlink">&para;</a></h2>
<p>使用关系数据库时，普遍要做的是连接多个表并明确地运用各种 JOIN 查询。
JOIN SQL语句的查询条件和参数，使用 <a href="./yii-db-activequery.html#joinWith()-detail">yii\db\ActiveQuery::joinWith()</a>
可以重用已定义关系并调用
而不是使用 <a href="./yii-db-query.html#join()-detail">yii\db\ActiveQuery::join()</a> 来实现目标。</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;查找所有订单并以客户&nbsp;ID&nbsp;和订单&nbsp;ID&nbsp;排序，并贪婪加载&nbsp;"customer"&nbsp;表<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">orderBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer.id,&nbsp;order.id'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;查找包括书籍的所有订单，并以&nbsp;`INNER&nbsp;JOIN`&nbsp;的连接方式即时加载&nbsp;"books"&nbsp;表<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">innerJoinWith</span><span style="color: #007700">(</span><span style="color: #DD0000">'books'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span></code></pre>
<p>以上，方法 <a href="./yii-db-activequery.html#innerJoinWith()-detail">innerJoinWith()</a> 是访问 <code>INNER JOIN</code> 类型的  <a href="./yii-db-activequery.html#joinWith()-detail">joinWith()</a> 的快捷方式。
。</p>
<p>可以连接一个或多个关联关系，可以自由使用查询条件到关联查询，
也可以嵌套连接关联查询。如：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;连接多重关系<br />//&nbsp;找出24小时内注册客户包含书籍的订单<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">innerJoinWith</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'books'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'customer'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;function&nbsp;(</span><span style="color: #0000BB">$query</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer.created_at&nbsp;&gt;&nbsp;'&nbsp;</span><span style="color: #007700">.&nbsp;(</span><span style="color: #0000BB">time</span><span style="color: #007700">()&nbsp;-&nbsp;</span><span style="color: #0000BB">24&nbsp;</span><span style="color: #007700">*&nbsp;</span><span style="color: #0000BB">3600</span><span style="color: #007700">));<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />])-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;连接嵌套关系：连接&nbsp;books&nbsp;表及其&nbsp;author&nbsp;列<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">(</span><span style="color: #DD0000">'books.author'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span></code></pre>
<p>代码背后， Yii 先执行一条 JOIN SQL 语句把满足 JOIN SQL 语句查询条件的主要模型查出，
然后为每个关系执行一条查询语句，
bing填充相应的关联记录。</p>
<p><a href="./yii-db-activequery.html#joinWith()-detail">joinWith()</a> 和  <a href="./yii-db-activequerytrait.html#with()-detail">with()</a> 的区别是
前者连接主模型类和关联模型类的数据表来检索主模型，
而后者只查询和检索主模型类。
检索主模型</p>
<p>由于这个区别，你可以应用只针对一条 JOIN SQL 语句起效的查询条件。
如，通过关联模型的查询条件过滤主模型，如前例，
可以使用关联表的列来挑选主模型数据，</p>
<p>当使用 <a href="./yii-db-activequery.html#joinWith()-detail">joinWith()</a> 方法时可以响应没有歧义的列名。
In the above examples, we use <code>item.id</code> and <code>order.id</code> to disambiguate the <code>id</code> column references
因为订单表和项目表都包括 <code>id</code> 列。</p>
<p>当连接关联关系时，关联关系默认使用即时加载。你可以
通过传参数 <code>$eagerLoading</code> 来决定在指定关联查询中是否使用即时加载。</p>
<p>默认 <a href="./yii-db-activequery.html#joinWith()-detail">joinWith()</a> 使用左连接来连接关联表。
你也可以传 <code>$joinType</code> 参数来定制连接类型。
你也可以使用 <a href="./yii-db-activequery.html#innerJoinWith()-detail">innerJoinWith()</a>。</p>
<p>以下是 <code>INNER JOIN</code> 的简短例子：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;查找包括书籍的所有订单，但&nbsp;"books"&nbsp;表不使用即时加载<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">innerJoinWith</span><span style="color: #007700">(</span><span style="color: #DD0000">'books'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;等价于：<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">(</span><span style="color: #DD0000">'books'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'INNER&nbsp;JOIN'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span></code></pre>
<p>有时连接两个表时，需要在关联查询的 ON 部分指定额外条件。
这可以通过调用 <a href="./yii-db-activequery.html#onCondition()-detail">yii\db\ActiveQuery::onCondition()</a> 方法实现：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">User&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getBooks</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Item</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'owner_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">onCondition</span><span style="color: #007700">([</span><span style="color: #DD0000">'category_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>在上面， <a href="./yii-db-baseactiverecord.html#hasMany()-detail">hasMany()</a> 方法回传了一个 <a href="./yii-db-activequery.html">yii\db\ActiveQuery</a> 对象，
当你用 <a href="./yii-db-activequery.html#joinWith()-detail">joinWith()</a> 执行一条查询时，取决于正被调用的是哪个 <a href="./yii-db-activequery.html#onCondition()-detail">onCondition()</a>，
返回 <code>category_id</code> 为 1 的 items </p>
<p>当你用 <a href="./yii-db-activequery.html#joinWith()-detail">joinWith()</a> 进行一次查询时，“on-condition”条件会被放置在相应查询语句的 ON 部分，
如：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;user.*&nbsp;FROM&nbsp;user&nbsp;LEFT&nbsp;JOIN&nbsp;item&nbsp;ON&nbsp;item.owner_id=user.id&nbsp;AND&nbsp;category_id=1<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;item&nbsp;WHERE&nbsp;owner_id&nbsp;IN&nbsp;(...)&nbsp;AND&nbsp;category_id=1<br /></span><span style="color: #0000BB">$users&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">User</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">(</span><span style="color: #DD0000">'books'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span></code></pre>
<p>注意：如果通过 <a href="./yii-db-activequerytrait.html#with()-detail">yii\db\ActiveQuery::with()</a> 进行贪婪加载或使用惰性加载的话，则 on 条件会被放置在对应 SQL语句的 <code>WHERE</code> 部分。
因为，此时此处并没有发生 JOIN 查询。比如：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;user&nbsp;WHERE&nbsp;id=10<br /></span><span style="color: #0000BB">$user&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">User</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">10</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;item&nbsp;WHERE&nbsp;owner_id=10&nbsp;AND&nbsp;category_id=1<br /></span><span style="color: #0000BB">$books&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$user</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">books</span><span style="color: #007700">;</span></code></pre>
<h2>关联表操作 <a href="#guan-lian-biao-cao-zuo" name="guan-lian-biao-cao-zuo" class="hashlink">&para;</a></h2>
<p>ActiveRecord 提供下列两个方法来建立或移除
两个 ActiveRecord 对象之间的关系。</p>
<ul>
<li><a href="./yii-db-baseactiverecord.html#link()-detail">link()</a></li>
<li><a href="./yii-db-baseactiverecord.html#unlink()-detail">unlink()</a></li>
</ul>
<p>如，给定一个客户和一个新订单，我们可以使用以下代码
把订单和客户关联起来：</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$order&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$order</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subtotal&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">100</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">link</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$order</span><span style="color: #007700">);</span></code></pre>
<p>上面调用的 <a href="./yii-db-baseactiverecord.html#link()-detail">link()</a> 会设置 order 的 <code>customer_id</code> 为主键
$customer 的值，然后调用  <a href="./yii-db-baseactiverecord.html#save()-detail">save()</a>  方法保存订单到数据库。</p>
<h2>作用域 <a href="#zuo-yong-yu" name="zuo-yong-yu" class="hashlink">&para;</a></h2>
<p>当调用<a href="./yii-db-activerecord.html#find()-detail">find()</a>或<a href="./yii-db-activerecord.html#findBySql()-detail">findBySql()</a>方法，
将返回<a href="./yii-db-activequery.html">ActiveQuery</a> 实例。
你也可以调用其他方法，如 <a href="./yii-db-querytrait.html#where()-detail">where()</a>, <a href="./yii-db-querytrait.html#orderBy()-detail">orderBy()</a>,
以更细化查询条件。</p>
<p>有可能需要不同地方多次调用同一个查询方法集合，这种情况，
可以考虑定义一个所谓的作用域（<em>scopes</em>），作用域本质上也是一个方法，定义在一个自定的查询类中，这个类
调用了一系列的查询方法来修正查询对象，使用作用域方法如同调用一个普通查询方法一样。</p>
<p>定义一个作用域方法需要两个步骤，首先为模型创建一个自定的查询类并在此类定义必须的作用域方法。
如，为 <code>Comment</code> 模型创建 <code>CommentQuery</code> 类，
 定义<code>active()</code>作用域方法如下：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">app</span><span style="color: #007700">\</span><span style="color: #0000BB">models</span><span style="color: #007700">;<br /><br />use&nbsp;</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveQuery</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">CommentQuery&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveQuery<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">active</span><span style="color: #007700">(</span><span style="color: #0000BB">$state&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">andWhere</span><span style="color: #007700">([</span><span style="color: #DD0000">'active'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$state</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>重点是：</p>
<ol>
<li>类必须继承自 <code>yii\db\ActiveQuery</code>或其子类。
2.方法必须是公开的并返回 <code>$this</code> 以便方法链成立。可以接收参数。
3.确认 <a href="./yii-db-activequery.html">yii\db\ActiveQuery</a> 方法对修改查询条件非常有用。</li>
</ol>
<p>其次，覆写 <span style="background: #ff0;">yii\db\ActiveRecord</span><span style="background: #f00;">::createQuery()</span> 方法以便可以使用自定的查询类而不是默认的 <a href="./yii-db-activequery.html">ActiveQuery</a> 类。
以下是示例：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">app</span><span style="color: #007700">\</span><span style="color: #0000BB">models</span><span style="color: #007700">;<br /><br />use&nbsp;</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">Comment&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;</span><span style="color: #0000BB">createQuery</span><span style="color: #007700">(</span><span style="color: #0000BB">$config&nbsp;</span><span style="color: #007700">=&nbsp;[])<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$config</span><span style="color: #007700">[</span><span style="color: #DD0000">'modelClass'</span><span style="color: #007700">]&nbsp;=&nbsp;</span><span style="color: #0000BB">get_called_class</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;</span><span style="color: #0000BB">CommentQuery</span><span style="color: #007700">(</span><span style="color: #0000BB">$config</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>就这样。现在你可以使用自定的作用域方法了：</p>
<pre><code class="language-php"><span style="color: #0000BB">$comments&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Comment</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">active</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$inactiveComments&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Comment</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">active</span><span style="color: #007700">(</span><span style="color: #0000BB">false</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span></code></pre>
<p>当定义关联关系时也可以使用作用域，如：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Post&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getActiveComments</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Comment</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'post_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">active</span><span style="color: #007700">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>或当执行关联查询时使用作用域传输：</p>
<pre><code class="language-php"><span style="color: #0000BB">$posts&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'comments'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;function(</span><span style="color: #0000BB">$q</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$q</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">active</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />])-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span></code></pre>
<h3>让 IDE 更好地支持 <a href="#rang-ide-geng-hao-de-zhi-chi" name="rang-ide-geng-hao-de-zhi-chi" class="hashlink">&para;</a></h3>
<p>为了让现代 IDE 自动完成更智能，你需要为一些模型和查询方法覆写返回类型，
如下：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">/**<br />&nbsp;*&nbsp;@method&nbsp;\app\models\CommentQuery|static|null&nbsp;find($q&nbsp;=&nbsp;null)&nbsp;static<br />&nbsp;*&nbsp;@method&nbsp;\app\models\CommentQuery&nbsp;findBySql($sql,&nbsp;$params&nbsp;=&nbsp;[])&nbsp;static<br />&nbsp;*/<br /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Comment&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /></span><span style="color: #007700">}</span></code></pre>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">/**<br />&nbsp;*&nbsp;@method&nbsp;\app\models\Comment|array|null&nbsp;one($db&nbsp;=&nbsp;null)<br />&nbsp;*&nbsp;@method&nbsp;\app\models\Comment[]|array&nbsp;all($db&nbsp;=&nbsp;null)<br />&nbsp;*/<br /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">CommentQuery&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveQuery<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /></span><span style="color: #007700">}</span></code></pre>
<h3>默认作用域 <a href="#mo-ren-zuo-yong-yu" name="mo-ren-zuo-yong-yu" class="hashlink">&para;</a></h3>
<p> 如果你以前曾用过 Yii 1.1,你已经了解一个缺省作用域的概念。缺省作用域就是对所有的数据库查询生效的作用域。
 你可以通过覆写 <span style="background: #ff0;">yii\db\ActiveRecord</span><span style="background: #f00;">::createQuery()</span> 方法来自定义缺省作用域，如</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">public&nbsp;static&nbsp;function&nbsp;</span><span style="color: #0000BB">createQuery</span><span style="color: #007700">(</span><span style="color: #0000BB">$config&nbsp;</span><span style="color: #007700">=&nbsp;[])<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$config</span><span style="color: #007700">[</span><span style="color: #DD0000">'modelClass'</span><span style="color: #007700">]&nbsp;=&nbsp;</span><span style="color: #0000BB">get_called_class</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(new&nbsp;</span><span style="color: #0000BB">ActiveQuery</span><span style="color: #007700">(</span><span style="color: #0000BB">$config</span><span style="color: #007700">))-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">([</span><span style="color: #DD0000">'deleted'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">]);<br />}</span></code></pre>
<p>注意现在你的所有查询都不能使用<a href="./yii-db-querytrait.html#where()-detail">where()</a>方法，
只能使用<a href="./yii-db-querytrait.html#where()-detail">where()</a>和<a href="./yii-db-querytrait.html#orWhere()-detail">orWhere()</a>方法，
以避免覆写了缺省条件。</p>
<h2>事务处理 <a href="#shi-wu-chu-li" name="shi-wu-chu-li" class="hashlink">&para;</a></h2>
<p>当一些 DB 操作是相关的且被同时执行</p>
<p>TODO: FIXME: WIP, TBD, <a href="https://github.com/yiisoft/yii2/issues/226">https://github.com/yiisoft/yii2/issues/226</a></p>
<p>,
<a href="./yii-db-baseactiverecord.html#afterSave()-detail">afterSave()</a>, <a href="./yii-db-baseactiverecord.html#beforeDelete()-detail">beforeDelete()</a> 和 <a href="./yii-db-baseactiverecord.html#afterDelete()-detail">afterDelete()</a>生命周期方法. 
开发者的解决方案是通过数据库事务包覆写<a href="./yii-db-baseactiverecord.html#save()-detail">save()</a>方法
甚至在控制器功能方法中使用事务，这个解决方式严格来说不是最佳实践
(违背了 “小控制器大模型”的基本规则）。</p>
<p>以下就是这些方式（<strong>不要</strong> 使用，除非你确定你真的需要这么做）。模型：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Feature&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">getProduct</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasOne</span><span style="color: #007700">(</span><span style="color: #0000BB">Product</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'product_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br />class&nbsp;</span><span style="color: #0000BB">Product&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">getFeatures</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Feature</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'product_id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>重写 <a href="./yii-db-baseactiverecord.html#save()-detail">save()</a> 方法：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">ProductController&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">web</span><span style="color: #007700">\</span><span style="color: #0000BB">Controller<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">actionCreate</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;FIXME:&nbsp;TODO:&nbsp;WIP,&nbsp;TBD<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br />}</span></code></pre>
<p>控制器层面使用事务处理</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">ProductController&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">web</span><span style="color: #007700">\</span><span style="color: #0000BB">Controller<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">actionCreate</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;FIXME:&nbsp;TODO:&nbsp;WIP,&nbsp;TBD<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br />}</span></code></pre>
<p>代替以上弱相关的方法，可以使用原子级场景和操作特性。</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Feature&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">getProduct</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasOne</span><span style="color: #007700">(</span><span style="color: #0000BB">Product</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'product_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">scenarios</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'userCreates'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'attributes'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[</span><span style="color: #DD0000">'name'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'value'</span><span style="color: #007700">],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'atomic'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">OP_INSERT</span><span style="color: #007700">],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br />class&nbsp;</span><span style="color: #0000BB">Product&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">getFeatures</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Feature</span><span style="color: #007700">::</span><span style="color: #0000BB">className</span><span style="color: #007700">(),&nbsp;[</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'product_id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">scenarios</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'userCreates'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'attributes'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[</span><span style="color: #DD0000">'title'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'price'</span><span style="color: #007700">],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'atomic'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">OP_INSERT</span><span style="color: #007700">],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">afterValidate</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">afterValidate</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;FIXME:&nbsp;TODO:&nbsp;WIP,&nbsp;TBD<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">afterSave</span><span style="color: #007700">(</span><span style="color: #0000BB">$insert</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">afterSave</span><span style="color: #007700">(</span><span style="color: #0000BB">$insert</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getScenario</span><span style="color: #007700">()&nbsp;===&nbsp;</span><span style="color: #DD0000">'userCreates'</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;FIXME:&nbsp;TODO:&nbsp;WIP,&nbsp;TBD<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span></code></pre>
<p>控制器非常简洁：</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">ProductController&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">web</span><span style="color: #007700">\</span><span style="color: #0000BB">Controller<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">actionCreate</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;FIXME:&nbsp;TODO:&nbsp;WIP,&nbsp;TBD<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br />}</span></code></pre>
<h2>乐观锁（Optimistic Locks） <a href="#le-guan-suo-optimistic-locks" name="le-guan-suo-optimistic-locks" class="hashlink">&para;</a></h2>
<p>TODO</p>
<h2>被污染属性 <a href="#bei-wu-ran-shu-xing" name="bei-wu-ran-shu-xing" class="hashlink">&para;</a></h2>
<p>TODO</p>
<h2>另见 <a href="#ling-jian" name="ling-jian" class="hashlink">&para;</a></h2>
<ul>
<li><a href="guide-model.html">模型（Model）</a></li>
<li><a href="./yii-db-activerecord.html">yii\db\ActiveRecord</a></li>
</ul>
        <div class="toplink"><a href="#" class="h1" title="go to top"><span class="glyphicon glyphicon-arrow-up"></a></div>
    </div>
</div>


</div>

<footer class="footer">
        <p class="pull-right"><small>Page generated on Thu, 04 Sep 2014 18:26:35 +0200</small></p>
    Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></footer>

<script type="text/javascript">jQuery(document).ready(function () {
    var shiftWindow = function () { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
var element = document.createElement("script");
element.src = "./jssearch.index.js";
document.body.appendChild(element);

var searchBox = $('#searchbox');

// focus the search field
searchBox.focus();

// search when typing in search field
searchBox.on("keyup", function(event) {
    var query = $(this).val();

    if (query == '' || event.which == 27) {
        $('#search-resultbox').hide();
        return;
    } else if (event.which == 13) {
        var selectedLink = $('#search-resultbox a.selected');
        if (selectedLink.length != 0) {
            document.location = selectedLink.attr('href');
            return;
        }
    } else if (event.which == 38 || event.which == 40) {
        $('#search-resultbox').show();

        var selected = $('#search-resultbox a.selected');
        if (selected.length == 0) {
            $('#search-results').find('a').first().addClass('selected');
        } else {
            var next;
            if (event.which == 40) {
                next = selected.parent().next().find('a').first();
            } else {
                next = selected.parent().prev().find('a').first();
            }
            if (next.length != 0) {
                var resultbox = $('#search-results');
                var position = next.position();

//              TODO scrolling is buggy and jumps around
//                resultbox.scrollTop(Math.floor(position.top));
//                console.log(position.top);

                selected.removeClass('selected');
                next.addClass('selected');
            }
        }

        return;
    }
    $('#search-resultbox').show();
    $('#search-results').html('<li><span class="no-results">No results</span></li>');

    var result = jssearch.search(query);

    if (result.length > 0) {
        var i = 0;
        var resHtml = '';

        for (var key in result) {
            if (i++ > 20) {
                break;
            }
            resHtml = resHtml +
            '<li><a href="' + result[key].file.u.substr(3) +'"><span class="title">' + result[key].file.t + '</span>' +
            '<span class="description">' + result[key].file.d + '</span></a></li>';
        }
        $('#search-results').html(resHtml);
    }
});

// hide the search results on ESC
$(document).on("keyup", function(event) { if (event.which == 27) { $('#search-resultbox').hide(); } });
// hide search results on click to document
$(document).bind('click', function (e) { $('#search-resultbox').hide(); });
// except the following:
searchBox.bind('click', function(e) { e.stopPropagation(); });
$('#search-resultbox').bind('click', function(e) { e.stopPropagation(); });

});</script></body>
</html>
